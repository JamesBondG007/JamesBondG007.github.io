<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spotify Artist Playlist Builder</title>
<style>
  body { font-family: sans-serif; text-align: center; padding: 2rem; background: #121212; color: #fff; }
  input, button { padding: 0.5rem; margin: 0.5rem; font-size: 1rem; }
  a { color: #1DB954; }
</style>
</head>
<body>
<h1>Spotify Artist Playlist Generator</h1>
<p id="intro">Login with Spotify first, then enter an artist name to generate a playlist.</p>

<button id="login">Login with Spotify</button>
<div id="app" style="display:none;">
  <input id="artist" placeholder="Artist name">
  <button id="go">Generate Playlist</button>
  <p id="status"></p>
</div>

<script>
const CLIENT_ID = "0c61694d0de448e0ab8eb089d98cf476";
const REDIRECT_URI = "https://jamesbondg007.github.io/spotify";
const SCOPES = "playlist-modify-public playlist-modify-private";

// Extract token from URL hash
function getTokenFromHash() {
  const hash = window.location.hash.substring(1).split('&').reduce((acc, cur) => {
    const [k, v] = cur.split('=');
    acc[k] = decodeURIComponent(v);
    return acc;
  }, {});
  return hash.access_token;
}

// Redirect to Spotify login
function login() {
  const authURL = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
  window.location = authURL;
}

// Fetch JSON with auth
async function getJSON(url, token) {
  const res = await fetch(url, { headers: { Authorization: "Bearer " + token } });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

// Fetch paginated results
async function fetchAll(url, token) {
  let results = [];
  while (url) {
    const data = await getJSON(url, token);
    results = results.concat(data.items);
    url = data.next;
  }
  return results;
}

// Main playlist generator
async function main(token) {
  const artistName = document.getElementById("artist").value.trim();
  if (!artistName) return alert("Enter an artist name first!");
  const status = document.getElementById("status");
  status.textContent = "Searching artist...";

  const search = await getJSON(`https://api.spotify.com/v1/search?q=${encodeURIComponent(artistName)}&type=artist&limit=1`, token);
  const artist = search.artists.items[0];
  if (!artist) return alert("Artist not found.");

  status.textContent = "Fetching albums...";
  const albums = await fetchAll(`https://api.spotify.com/v1/artists/${artist.id}/albums?include_groups=album,single,appears_on&limit=50`, token);

  const trackMap = new Map();
  status.textContent = `Gathering tracks from ${albums.length} albums...`;

  for (const album of albums) {
    const tracks = await fetchAll(`https://api.spotify.com/v1/albums/${album.id}/tracks?limit=50`, token);
    for (const track of tracks) {
      if (!trackMap.has(track.id)) trackMap.set(track.id, track);
    }
  }

  const trackIds = Array.from(trackMap.keys());
  status.textContent = `Loaded ${trackIds.length} unique tracks, fetching popularity...`;

  const tracksData = [];
  for (let i = 0; i < trackIds.length; i += 50) {
    const batch = trackIds.slice(i, i + 50).join(",");
    const data = await getJSON(`https://api.spotify.com/v1/tracks?ids=${batch}`, token);
    tracksData.push(...data.tracks);
  }

  tracksData.sort((a, b) => b.popularity - a.popularity);

  status.textContent = "Creating playlist...";
  const me = await getJSON("https://api.spotify.com/v1/me", token);
  const playlist = await fetch(`https://api.spotify.com/v1/users/${me.id}/playlists`, {
    method: "POST",
    headers: { Authorization: "Bearer " + token, "Content-Type": "application/json" },
    body: JSON.stringify({ name: `${artist.name} — All Songs (by Popularity)`, description: "Generated with GitHub.io + Spotify API" })
  }).then(r => r.json());

  for (let i = 0; i < tracksData.length; i += 100) {
    const uris = tracksData.slice(i, i + 100).map(t => t.uri);
    await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
      method: "POST",
      headers: { Authorization: "Bearer " + token, "Content-Type": "application/json" },
      body: JSON.stringify({ uris })
    });
  }

  status.innerHTML = `✅ Playlist created: <a href="${playlist.external_urls.spotify}" target="_blank">${playlist.name}</a>`;
}

// Page load
const token = getTokenFromHash();
if (token) {
  document.getElementById("login").style.display = "none";
  document.getElementById("app").style.display = "block";
}

// Event listeners
document.getElementById("login").onclick = login;
document.getElementById("go").onclick = () => main(token);
</script>
</body>
</html>
